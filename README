## 环境要求

- kernel>=4.5
- ceph-common version >= ceph version


## 方案介绍

部署两个Harbor实例来实现高可用, 存储使用CephRBD, RBD块设备是独占存储, 性能上要优于NAS存储.
这意味着同时只有一个实例在正常运行对外提供服务. 单实例的优点显而易见, RBD带来的性能优势, 部署上简单. 因为是公司内网使用, 对Harbor的并发读取操作很低, 极端情况下(几乎不可能出现)也只能有几千的并发. 所以单Harbor实例提供服务是可行的.
但是单实例存在一个单点故障的问题, 为了解决这个问题, 我们借助Keepalived的故障切换的能力实现故障转移. 缺点是, 在故障切换的过程中存在一定时间的服务不可用时间, 这个时间点多少取决于基础设置性能. 所以,总结来看改方案:

优势:

- RBD存储带来的性能优势
- 部署上简单易于维护和部署

缺点:

- 故障转移期间服务不可用约几分钟

## 主要组件

- Keepalived
- Harbor健康检查脚本(keepalived使用)`harbor-healthz.sh`
- 故障转移脚本`failover.sh`


故障转移是一个systemd服务, 定时执行指定脚本. 来判断是否发生了故障转移.

## Keepalived

docker run --cap-add=NET_ADMIN --cap-add=NET_BROADCAST --cap-add=NET_RAW --net=host -d osixia/keepalived:2.0.20
docker run --volume /data/my-keepalived.conf:/container/service/keepalived/assets/keepalived.conf --detach osixia/keepalived:2.0.20
## Harbor的安装